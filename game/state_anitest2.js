var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { tt } from "../ttapi_interface/ttapi.js";
import * as tt2 from "../ttapi_layer2/ttlayer2.js";
import { UITool } from "./uitool.js";
import { State_Logo } from "./state_logo.js";
class MyPlayerData {
}
class Vector2Func {
    //匀速移动方法
    //return false 表示到达
    static Goto(data, to, speed, delta) {
        let x = data.posX;
        let y = data.posY;
        //可以用tt.vector2.Dist 系列方法计算，但是面向对象=缓慢，能少用对象则少用
        let dist = Math.sqrt((x - to.X) * (x - to.X) + (y - to.Y) * (y - to.Y));
        if (dist < 1)
            return false;
        //可以用tt.vector2.Dir 系列方法计算，这里是展开形态
        let dirX = (to.X - x) / dist;
        let dirY = (to.Y - y) / dist;
        let movedist = speed * delta;
        data.posX = x + dirX * movedist;
        data.posY = y + dirY * movedist;
        //本来写了下面的代码，有点啰嗦，封装一下
        tt2.QAni_UpdatePlayerAniByPos(data, to.X, to.Y);
        //用水平方向改一下方向
        // if (dirX < 0&&data.direction!=tt2.QAni_Direction.Left)
        // {    
        //      data.direction = tt2.QAni_Direction.Left;
        //      tt2.QAni_UpdatePlayerAni(data);
        // }
        // if (dirX > 0&&data.direction!=tt2.QAni_Direction.Right)
        // {
        //     data.direction = tt2.QAni_Direction.Right;
        //     tt2.QAni_UpdatePlayerAni(data);
        // }
        return true;
    }
}
export class State_AniTest2 {
    OnInit(statemgr) {
        this.app = statemgr;
        this.hasinited = false;
        this.StartAsync();
    }
    //自己封装一个CreatePlayer函数，在其中应用懒汉模式
    CreatePlayer() {
        return __awaiter(this, void 0, void 0, function* () {
            let player = tt2.QAni_PlayerMgr.CreatePlayer("p1");
            if (player == null) {
                let atlas = yield tt2.QFrame_ResMgr.LoadAtlasAsync("data/splittex_pack0.png.json");
                let json = yield tt.loader.LoadStringAsync("data/monster.json");
                tt2.QAni_PlayerMgr.LoadPlayerInfo("data/splittex_pack0.png.json", JSON.parse(json));
                player = tt2.QAni_PlayerMgr.CreatePlayer("p1");
            }
            if (player == null) {
                throw new Error("加载Main Player 失败");
            }
            player.userdata = new MyPlayerData();
            return player;
        });
    }
    StartAsync() {
        return __awaiter(this, void 0, void 0, function* () {
            this.app.target.ClearColor = new tt.Color(0, 0, 0, 1.0);
            //players
            this.players = [];
            for (var i = 0; i < 10; i++) {
                //转为MyPlayerData 加几个属性进去
                let p = yield this.CreatePlayer();
                //换一个侵入性更低的方法，之前的方法有被滥用的迹象
                p.posX = Math.random() * 200 - 100;
                p.posY = i * 64;
                p.userdata.targetA = new tt.Vector2(-200, p.posY);
                p.userdata.targetB = new tt.Vector2(+200, p.posY);
                p.userdata.speed = 100 + Math.random() * 100;
                this.players.push(p);
            }
            this.app.batcherBottom.LookAt.X = 0;
            this.app.batcherBottom.LookAt.Y = 0;
            //加一个退出按钮
            let btn = yield UITool.CreateButton(this.app.font, "<--");
            btn.localRect.setByRect(new tt.Rectangle(50, 100, 150, 50));
            this.app.canvas.addChild(btn);
            btn.OnClick = () => {
                this.app.ChangeState(new State_Logo());
            };
            this.hasinited = true;
        });
    }
    OnExit() {
        this.app.canvas.removeChildAll();
    }
    OnUpdate(delta) {
        if (!this.hasinited)
            return;
        //批量更新动画
        //排序
        this.players.sort((a, b) => {
            return a.posY - b.posY;
        });
        this.UpdatePlayerMove(delta);
        tt2.QAni_PlayerMgr.UpdatePlayers_Ani(this.players, delta);
    }
    //把角色集中起来控制
    UpdatePlayerMove(delta) {
        for (var i = 0; i < this.players.length; i++) {
            let p = this.players[i];
            let b = Vector2Func.Goto(p, p.userdata.targetB, p.userdata.speed, delta);
            if (b == false) //到达
             { //交换两点
                let t = p.userdata.targetA;
                p.userdata.targetA = p.userdata.targetB;
                p.userdata.targetB = t;
            }
        }
    }
    OnRender() {
        if (!this.hasinited)
            return;
        this.app.batcherBottom.BeginDraw(this.app.target);
        tt2.QAni_PlayerMgr.RenderPlayers(this.app.batcherBottom, this.players);
        this.app.batcherBottom.EndDraw();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfYW5pdGVzdDIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGF0ZV9hbml0ZXN0Mi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sNkJBQTZCLENBQUE7QUFDaEQsT0FBTyxLQUFLLEdBQUcsTUFBTSw2QkFBNkIsQ0FBQTtBQUVsRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUk3QyxNQUFNLFlBQVk7Q0FJakI7QUFDRCxNQUFNLFdBQVc7SUFDYixRQUFRO0lBQ1IsbUJBQW1CO0lBQ25CLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBbUMsRUFBRSxFQUFjLEVBQUUsS0FBYSxFQUFFLEtBQWE7UUFDekYsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ2xCLDhDQUE4QztRQUM5QyxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hFLElBQUksSUFBSSxHQUFHLENBQUM7WUFDUixPQUFPLEtBQUssQ0FBQztRQUVqQixrQ0FBa0M7UUFDbEMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUM3QixJQUFJLElBQUksR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFB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QUMsQ0FBQztRQUVsRCxHQUFHLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdkUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDckMsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdHQgfSBmcm9tIFwiLi4vdHRhcGlfaW50ZXJmYWNlL3R0YXBpLmpzXCJcclxuaW1wb3J0ICogYXMgdHQyIGZyb20gXCIuLi90dGFwaV9sYXllcjIvdHRsYXllcjIuanNcIlxyXG5cclxuaW1wb3J0IHsgVUlUb29sIH0gZnJvbSBcIi4vdWl0b29sLmpzXCI7XHJcbmltcG9ydCB7IFN0YXRlX0xvZ28gfSBmcm9tIFwiLi9zdGF0ZV9sb2dvLmpzXCI7XHJcbmltcG9ydCB7IFVzZXJEYXRhIH0gZnJvbSBcIi4vdXNlcmRhdGEuanNcIjtcclxuaW1wb3J0IHsgUUFuaV9QbGF5ZXIgfSBmcm9tIFwiLi4vdHRhcGlfbGF5ZXIyL3R0bGF5ZXIyLmpzXCI7XHJcblxyXG5jbGFzcyBNeVBsYXllckRhdGEge1xyXG4gICAgdGFyZ2V0QTogdHQuVmVjdG9yMjtcclxuICAgIHRhcmdldEI6IHR0LlZlY3RvcjI7XHJcbiAgICBzcGVlZDogbnVtYmVyO1xyXG59XHJcbmNsYXNzIFZlY3RvcjJGdW5jIHtcclxuICAgIC8v5YyA6YCf56e75Yqo5pa55rOVXHJcbiAgICAvL3JldHVybiBmYWxzZSDooajnpLrliLDovr5cclxuICAgIHN0YXRpYyBHb3RvKGRhdGE6IHR0Mi5RQW5pX1BsYXllcjxNeVBsYXllckRhdGE+LCB0bzogdHQuVmVjdG9yMiwgc3BlZWQ6IG51bWJlciwgZGVsdGE6IG51bWJlcik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGxldCB4ID0gZGF0YS5wb3NYO1xyXG4gICAgICAgIGxldCB5ID0gZGF0YS5wb3NZO1xyXG4gICAgICAgIC8v5Y+v5Lul55SodHQudmVjdG9yMi5EaXN0IOezu+WIl+aWueazleiuoeeul++8jOS9huaYr+mdouWQkeWvueixoT3nvJPmhaLvvIzog73lsJHnlKjlr7nosaHliJnlsJHnlKhcclxuICAgICAgICBsZXQgZGlzdCA9IE1hdGguc3FydCgoeCAtIHRvLlgpICogKHggLSB0by5YKSArICh5IC0gdG8uWSkgKiAoeSAtIHRvLlkpKTtcclxuICAgICAgICBpZiAoZGlzdCA8IDEpXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuXHJcbiAgICAgICAgLy/lj6/ku6XnlKh0dC52ZWN0b3IyLkRpciDns7vliJfmlrnms5XorqHnrpfvvIzov5nph4zmmK/lsZXlvIDlvaLmgIFcclxuICAgICAgICBsZXQgZGlyWCA9ICh0by5YIC0geCkgLyBkaXN0O1xyXG4gICAgICAgIGxldCBkaXJZID0gKHRvLlkgLSB5KSAvIGRpc3Q7XHJcblxyXG4gICAgICAgIGxldCBtb3ZlZGlzdCA9IHNwZWVkICogZGVsdGE7XHJcbiAgICAgICAgZGF0YS5wb3NYID0geCArIGRpclggKiBtb3ZlZGlzdDtcclxuICAgICAgICBkYXRhLnBvc1kgPSB5ICsgZGlyWSAqIG1vdmVkaXN0O1xyXG5cclxuXHJcbiAgICAgICAgLy/mnKzmnaXlhpnkuobkuIvpnaLnmoTku6PnoIHvvIzmnInngrnllbDll6bvvIzlsIHoo4XkuIDkuItcclxuICAgICAgICB0dDIuUUFuaV9VcGRhdGVQbGF5ZXJBbmlCeVBvcyhkYXRhLCB0by5YLCB0by5ZKTtcclxuXHJcblxyXG4gICAgICAgIC8v55So5rC05bmz5pa55ZCR5pS55LiA5LiL5pa55ZCRXHJcbiAgICAgICAgLy8gaWYgKGRpclggPCAwJiZkYXRhLmRpcmVjdGlvbiE9dHQyLlFBbmlfRGlyZWN0aW9uLkxlZnQpXHJcbiAgICAgICAgLy8geyAgICBcclxuICAgICAgICAvLyAgICAgIGRhdGEuZGlyZWN0aW9uID0gdHQyLlFBbmlfRGlyZWN0aW9uLkxlZnQ7XHJcbiAgICAgICAgLy8gICAgICB0dDIuUUFuaV9VcGRhdGVQbGF5ZXJBbmkoZGF0YSk7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIC8vIGlmIChkaXJYID4gMCYmZGF0YS5kaXJlY3Rpb24hPXR0Mi5RQW5pX0RpcmVjdGlvbi5SaWdodClcclxuICAgICAgICAvLyB7XHJcbiAgICAgICAgLy8gICAgIGRhdGEuZGlyZWN0aW9uID0gdHQyLlFBbmlfRGlyZWN0aW9uLlJpZ2h0O1xyXG4gICAgICAgIC8vICAgICB0dDIuUUFuaV9VcGRhdGVQbGF5ZXJBbmkoZGF0YSk7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydCBjbGFzcyBTdGF0ZV9BbmlUZXN0MiBpbXBsZW1lbnRzIHR0Mi5RRnJhbWVfSVN0YXRlPFVzZXJEYXRhPlxyXG57XHJcbiAgICBhcHA6IHR0Mi5RRnJhbWVfQXBwPFVzZXJEYXRhPjtcclxuXHJcbiAgICBoYXNpbml0ZWQ6IGJvb2xlYW5cclxuXHJcblxyXG4gICAgcGxheWVyczogUUFuaV9QbGF5ZXI8TXlQbGF5ZXJEYXRhPltdO1xyXG5cclxuICAgIE9uSW5pdChzdGF0ZW1ncjogdHQyLlFGcmFtZV9BcHA8VXNlckRhdGE+KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5hcHAgPSBzdGF0ZW1ncjtcclxuXHJcbiAgICAgICAgdGhpcy5oYXNpbml0ZWQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLlN0YXJ0QXN5bmMoKTtcclxuICAgIH1cclxuICAgIC8v6Ieq5bex5bCB6KOF5LiA5LiqQ3JlYXRlUGxheWVy5Ye95pWw77yM5Zyo5YW25Lit5bqU55So5oeS5rGJ5qih5byPXHJcbiAgICBhc3luYyBDcmVhdGVQbGF5ZXIoKTogUHJvbWlzZTx0dDIuUUFuaV9QbGF5ZXI8TXlQbGF5ZXJEYXRhPj4ge1xyXG4gICAgICAgIGxldCBwbGF5ZXIgPSB0dDIuUUFuaV9QbGF5ZXJNZ3IuQ3JlYXRlUGxheWVyPE15UGxheWVyRGF0YT4oXCJwMVwiKTtcclxuICAgICAgICBpZiAocGxheWVyID09IG51bGwpIHtcclxuICAgICAgICAgICAgbGV0IGF0bGFzID0gYXdhaXQgdHQyLlFGcmFtZV9SZXNNZ3IuTG9hZEF0bGFzQXN5bmMoXCJkYXRhL3NwbGl0dGV4X3BhY2swLnBuZy5qc29uXCIpO1xyXG4gICAgICAgICAgICBsZXQganNvbiA9IGF3YWl0IHR0LmxvYWRlci5Mb2FkU3RyaW5nQXN5bmMoXCJkYXRhL21vbnN0ZXIuanNvblwiKTtcclxuICAgICAgICAgICAgdHQyLlFBbmlfUGxheWVyTWdyLkxvYWRQbGF5ZXJJbmZvKFwiZGF0YS9zcGxpdHRleF9wYWNrMC5wbmcuanNvblwiLCBKU09OLnBhcnNlKGpzb24pKTtcclxuICAgICAgICAgICAgcGxheWVyID0gdHQyLlFBbmlfUGxheWVyTWdyLkNyZWF0ZVBsYXllcihcInAxXCIpO1xyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHBsYXllciA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIuWKoOi9vU1haW4gUGxheWVyIOWksei0pVwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGxheWVyLnVzZXJkYXRhID0gbmV3IE15UGxheWVyRGF0YSgpO1xyXG4gICAgICAgIHJldHVybiBwbGF5ZXI7XHJcbiAgICB9XHJcbiAgICBhc3luYyBTdGFydEFzeW5jKCk6IFByb21pc2U8dm9pZD4ge1xyXG5cclxuXHJcblxyXG4gICAgICAgIHRoaXMuYXBwLnRhcmdldC5DbGVhckNvbG9yID0gbmV3IHR0LkNvbG9yKDAsIDAsIDAsIDEuMCk7XHJcblxyXG5cclxuXHJcbiAgICAgICAgLy9wbGF5ZXJzXHJcbiAgICAgICAgdGhpcy5wbGF5ZXJzID0gW107XHJcblxyXG5cclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEwOyBpKyspIHtcclxuICAgICAgICAgICAgLy/ovazkuLpNeVBsYXllckRhdGEg5Yqg5Yeg5Liq5bGe5oCn6L+b5Y67XHJcbiAgICAgICAgICAgIGxldCBwID0gYXdhaXQgdGhpcy5DcmVhdGVQbGF5ZXIoKTtcclxuICAgICAgICAgICAgLy/mjaLkuIDkuKrkvrXlhaXmgKfmm7TkvY7nmoTmlrnms5XvvIzkuYvliY3nmoTmlrnms5XmnInooqvmu6XnlKjnmoTov7nosaFcclxuXHJcbiAgICAgICAgICAgIHAucG9zWCA9IE1hdGgucmFuZG9tKCkgKiAyMDAgLSAxMDA7XHJcbiAgICAgICAgICAgIHAucG9zWSA9IGkgKiA2NDtcclxuICAgICAgICAgICAgcC51c2VyZGF0YS50YXJnZXRBID0gbmV3IHR0LlZlY3RvcjIoLSAyMDAsIHAucG9zWSk7XHJcbiAgICAgICAgICAgIHAudXNlcmRhdGEudGFyZ2V0QiA9IG5ldyB0dC5WZWN0b3IyKCsgMjAwLCBwLnBvc1kpO1xyXG4gICAgICAgICAgICBwLnVzZXJkYXRhLnNwZWVkID0gMTAwICsgTWF0aC5yYW5kb20oKSAqIDEwMDtcclxuICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2gocCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmFwcC5iYXRjaGVyQm90dG9tLkxvb2tBdC5YID0gMDtcclxuICAgICAgICB0aGlzLmFwcC5iYXRjaGVyQm90dG9tLkxvb2tBdC5ZID0gMDtcclxuXHJcbiAgICAgICAgLy/liqDkuIDkuKrpgIDlh7rmjInpkq5cclxuICAgICAgICBsZXQgYnRuID0gYXdhaXQgVUlUb29sLkNyZWF0ZUJ1dHRvbih0aGlzLmFwcC5mb250LCBcIjwtLVwiKTtcclxuICAgICAgICBidG4ubG9jYWxSZWN0LnNldEJ5UmVjdChuZXcgdHQuUmVjdGFuZ2xlKDUwLCAxMDAsIDE1MCwgNTApKTtcclxuICAgICAgICB0aGlzLmFwcC5jYW52YXMuYWRkQ2hpbGQoYnRuKTtcclxuICAgICAgICBidG4uT25DbGljayA9ICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5hcHAuQ2hhbmdlU3RhdGUobmV3IFN0YXRlX0xvZ28oKSk7XHJcbiAgICAgICAgfVxyXG5cclxuXHJcblxyXG4gICAgICAgIHRoaXMuaGFzaW5pdGVkID0gdHJ1ZTtcclxuICAgIH1cclxuICAgIE9uRXhpdCgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmFwcC5jYW52YXMucmVtb3ZlQ2hpbGRBbGwoKTtcclxuICAgIH1cclxuICAgIE9uVXBkYXRlKGRlbHRhOiBudW1iZXIpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIXRoaXMuaGFzaW5pdGVkKSByZXR1cm47XHJcblxyXG4gICAgICAgIC8v5om56YeP5pu05paw5Yqo55S7XHJcbiAgICAgICAgLy/mjpLluo9cclxuICAgICAgICB0aGlzLnBsYXllcnMuc29ydCgoYSwgYikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gYS5wb3NZIC0gYi5wb3NZO1xyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIHRoaXMuVXBkYXRlUGxheWVyTW92ZShkZWx0YSk7XHJcbiAgICAgICAgdHQyLlFBbmlfUGxheWVyTWdyLlVwZGF0ZVBsYXllcnNfQW5pKHRoaXMucGxheWVycywgZGVsdGEpO1xyXG4gICAgfVxyXG4gICAgLy/miorop5LoibLpm4bkuK3otbfmnaXmjqfliLZcclxuICAgIFVwZGF0ZVBsYXllck1vdmUoZGVsdGE6IG51bWJlcikge1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wbGF5ZXJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGxldCBwID0gdGhpcy5wbGF5ZXJzW2ldO1xyXG5cclxuICAgICAgICAgICAgbGV0IGIgPSBWZWN0b3IyRnVuYy5Hb3RvKHAsIHAudXNlcmRhdGEudGFyZ2V0QiwgcC51c2VyZGF0YS5zcGVlZCwgZGVsdGEpO1xyXG4gICAgICAgICAgICBpZiAoYiA9PSBmYWxzZSkvL+WIsOi+vlxyXG4gICAgICAgICAgICB7Ly/kuqTmjaLkuKTngrlcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgdCA9IHAudXNlcmRhdGEudGFyZ2V0QTtcclxuICAgICAgICAgICAgICAgIHAudXNlcmRhdGEudGFyZ2V0QSA9IHAudXNlcmRhdGEudGFyZ2V0QjtcclxuICAgICAgICAgICAgICAgIHAudXNlcmRhdGEudGFyZ2V0QiA9IHQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG4gICAgT25SZW5kZXIoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmhhc2luaXRlZCkgcmV0dXJuO1xyXG4gICAgICAgIHRoaXMuYXBwLmJhdGNoZXJCb3R0b20uQmVnaW5EcmF3KHRoaXMuYXBwLnRhcmdldCk7XHJcblxyXG4gICAgICAgIHR0Mi5RQW5pX1BsYXllck1nci5SZW5kZXJQbGF5ZXJzKHRoaXMuYXBwLmJhdGNoZXJCb3R0b20sIHRoaXMucGxheWVycyk7XHJcbiAgICAgICAgdGhpcy5hcHAuYmF0Y2hlckJvdHRvbS5FbmREcmF3KCk7XHJcbiAgICB9XHJcbn0iXX0=